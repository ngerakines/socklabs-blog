<!DOCTYPE html>
<html>
  <head>
	<link href="/css/style.css" media="screen" rel="stylesheet" type="text/css" />
    <title>Nick's Blog | Erlang snippet: Image type detection using binary matching
</title>
  </head>
  <body>
	<a href="/"><h1>Nick's Blog</h1></a>
	<div id="content">
		<div id="posts">
			<h2><a alt="Erlang snippet: Image type detection using binary matching
" href="/2008/07/08/erlang_snippet_image_type_dete.html">Erlang snippet: Image type detection using binary matching
</a></h2>
			<em id="sub_h2">08 July 2008</em>
		 	<p>I've been devoting more time to I Play WoW lately and the next feature in the skunkworks is much better image hosting. For a while I was using Facebook's albums to manage all of that stuff but in the end, I think its going to be better if I do it myself. The backend service is going to accept image uploads, track and manage them internally and use amazon s3 for storage.</p>

<p>Tonight I made a breakthrough in figuring out how to make sure that a given file is an image and that its dimensions fit within the expected scope. Basically, I want to restrict image uploads to .jpg, .gif and .png files that are less than 2048x2048 (that might change) and that are under 4 megs in size. I've been looking for a while for Erlang snippets or code that tie into imagemagik or gd to do this sort of detection, but in the end I didn't find anything that fit my needs so I decided to write a small library.To use the module, call the image_type/1 function with a string representing the path of the image file. You can also call the image_type/1 function with the binary data as is.</p>

<p>I've run it through a sample of 3k+ images without an issues and its picked up the type and dimensions each time. Depending on how much more image related functionality is added, I might release it on GitHub. This code is made available under the MIT license.</p>

<p>So this is what it looks like:</p>

<pre><code>-module(ipwfiles_image).
-compile(export_all).

image_type(Filename) when is_list(Filename) -&gt;
    case file:read_file(Filename) of
        {ok, FileHandle} -&gt; image_type(FileHandle);
        _ -&gt; error
    end;

%% Gif header, width and then height
image_type(&lt;&lt;71,73,70,56,55,97,Width:16/little,Height:16/little,_/binary&gt;&gt;) -&gt; {gif, Width, Height};
image_type(&lt;&lt;71,73,70,56,57,97,Width:16/little,Height:16/little,_/binary&gt;&gt;) -&gt; {gif, Width, Height};

%% PNG header, chunk1, width and height
%% spec: http://www.w3.org/TR/PNG/#
image_type(&lt;&lt;137,80,78,71,13,10,26,10,_:4/signed-integer-unit:8,73,72,68,82,Width:4/signed-integer-unit:8,Height:4/signed-integer-unit:8,_/binary&gt;&gt;) -&gt; {png, Width, Height};

%% JPEG
%% ref: http://www.obrador.com/essentialjpeg/headerinfo.htm
%% thanks http://www.ravenna.com/gifs/isize.pl
image_type(Data = &lt;&lt;255,216,255,224,_/binary&gt;&gt;) -&gt;
    {H, W} = parse_jpeg(Data),
    {jpeg, H, W};

image_type(_) -&gt; unknown.

%% SOF0: 255 192, SOF3: 255 195
%% SOI : 255 216, SOS : 255 218, SOF3: 255 195, EOI : 255 217, COM: 255 254

parse_jpeg(Data) -&gt; parse_jpeg(Data, {}).
parse_jpeg(&lt;&lt;&gt;&gt;, Results) -&gt; Results;
parse_jpeg(&lt;&lt;255,192,_:16/signed-integer,_:8,Width:16/signed-integer,Height:16/signed-integer,Rest/binary&gt;&gt;, _) -&gt;
    %% io:format("Marker SOF0 hit ~p ~p(~p)~n", [Height, Width, Pos]),
    parse_jpeg(Rest, {Height, Width});
%% parse_jpeg(&lt;&lt;255,195,Rest/binary&gt;&gt;, Pos) -&gt; parse_jpeg(Rest, Pos);
%% parse_jpeg(&lt;&lt;255,216,Rest/binary&gt;&gt;, Pos) -&gt; parse_jpeg(Rest, Pos);
%% parse_jpeg(&lt;&lt;255,218,Rest/binary&gt;&gt;, Pos) -&gt; parse_jpeg(Rest, Pos);
%% parse_jpeg(&lt;&lt;255,217,Rest/binary&gt;&gt;, Pos) -&gt; parse_jpeg(Rest, Pos);
%% parse_jpeg(&lt;&lt;255,254,Rest/binary&gt;&gt;, Pos) -&gt; parse_jpeg(Rest, Pos);
parse_jpeg(&lt;&lt;_,Rest/binary&gt;&gt;, Pos) -&gt; parse_jpeg(Rest, Pos).
</code></pre>

		</div>
		<div id="sidebar">
	<div class="clear"></div>
	<div id="sidebar_content">
		<h2>Recently</h2>
		
			<h3 style="padding-top: 10px;"><a alt="Integrating Heman into CalendERL About Nothing" href="/2009/12/28/integrating_heman_into_calenderl_about_nothing.html">Integrating Heman into CalendERL About Nothing</a></h3>
			<em id="sub_h3">28 December 2009</em>
		
			<h3 style="padding-top: 10px;"><a alt="Lets create some Erlang standards, part one" href="/2009/11/24/lets_create_some_erlang_standards_part_one.html">Lets create some Erlang standards, part one</a></h3>
			<em id="sub_h3">24 November 2009</em>
		
			<h3 style="padding-top: 10px;"><a alt="2009 Erlang User Conference" href="/2009/11/12/EUC2009.html">2009 Erlang User Conference</a></h3>
			<em id="sub_h3">12 November 2009</em>
		
			<h3 style="padding-top: 10px;"><a alt="CalendERL About Nothing" href="/2009/11/01/calenderl_about_nothing.html">CalendERL About Nothing</a></h3>
			<em id="sub_h3">01 November 2009</em>
		
			<h3 style="padding-top: 10px;"><a alt="Globally Shared Queues" href="/2009/10/26/globally_shared_queues.html">Globally Shared Queues</a></h3>
			<em id="sub_h3">26 October 2009</em>
		
		<h2 style="padding-top: 20px;"><a href="/about/">About</a></h2>
		<h2 style="padding-top: 20px;"><a href="/projects/">Projects</a></h2>
		<h2 style="padding-top: 20px;"><a href="/archives/">Archives</a></h2>
	</div>
</div>

		<div id="disqus_thread"></div>
	</div>
	<script type="text/javascript" src="http://disqus.com/forums/socklabs-blog/embed.js"></script>
<noscript>
	<a href="http://disqus.com/forums/socklabs-blog/?url=ref">View the discussion thread.</a>
</noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
<script type="text/javascript">
//<![CDATA[
(function() {
	var links = document.getElementsByTagName('a');
	var query = '?';
	for(var i = 0; i < links.length; i++) {
	if(links[i].href.indexOf('#disqus_thread') >= 0) {
		query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
	}
	}
	document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/socklabs-blog/get_num_replies.js' + query + '"></' + 'script>');
})();
//]]>
</script>

	<div class="clear"></div>
	<div id="footer">
	<a href="/" alt="blog"><b>Blog</b></a>
	| <a href="http://socklabs.com">Socklabs</a>
	| <a href="http://twitter.com/ngerakines" alt="status">On Twitter</a>
	| <a alt="ngerakines on Facebook" href="http://facebook.com/ngerakines">on Facebook</a>
</div>
	</body>
</html>